From f6e49e79c5fcacfab34919ab80dcde4f91be0ab5 Mon Sep 17 00:00:00 2001
From: Vicki Pfau <vi@endrift.com>
Date: Tue, 4 Apr 2023 22:09:52 -0700
Subject: [PATCH 3/3] Add a signal for CEC being made the active source

---
 src/libcec/ceccontroller.cpp                        | 9 ++++++++-
 src/libcec/ceccontroller.h                          | 2 ++
 src/libcec/org.kde.plasma.remotecontrollers.CEC.xml | 3 +++
 3 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/src/libcec/ceccontroller.cpp b/src/libcec/ceccontroller.cpp
index 5d2d6c5..34c00b3 100644
--- a/src/libcec/ceccontroller.cpp
+++ b/src/libcec/ceccontroller.cpp
@@ -66,6 +66,13 @@ void CECController::handleCommandReceived(void* param, const cec_command* comman
     }
 }
 
+void CECController::handleSourceActivated(void* param, const cec_logical_address address, uint8_t activated)
+{
+    Q_UNUSED(address);
+    CECController* self = static_cast<CECController*>(param);
+    QMetaObject::invokeMethod(self, "sourceActivated", Q_ARG(bool, activated));
+}
+
 void CECController::handleCompleteEvent(const int keycode, const int keyduration, const int opcode)
 {
     Q_UNUSED(keyduration);
@@ -151,7 +158,7 @@ CECController::CECController()
     m_cecCallbacks.Clear();
     m_cecCallbacks.keyPress = &CECController::handleCecKeypress;
     m_cecCallbacks.commandReceived = &CECController::handleCommandReceived;
-
+    m_cecCallbacks.sourceActivated = &CECController::handleSourceActivated;
 
     libcec_configuration cecConfig;
     cecConfig.Clear();
diff --git a/src/libcec/ceccontroller.h b/src/libcec/ceccontroller.h
index 87d218d..9d1e86c 100644
--- a/src/libcec/ceccontroller.h
+++ b/src/libcec/ceccontroller.h
@@ -38,6 +38,7 @@ public Q_SLOTS:
 
 Q_SIGNALS:
     Q_SCRIPTABLE void enterStandby();
+    Q_SCRIPTABLE bool sourceActivated(bool active);
 
 private:
     ICECAdapter* m_cecAdapter = nullptr;
@@ -50,6 +51,7 @@ private:
 
     static void handleCecKeypress(void* param, const cec_keypress* key);
     static void handleCommandReceived(void* param, const cec_command* command);
+    static void handleSourceActivated(void* param, const cec_logical_address address, uint8_t activated);
 
     static int m_hitcommand;
 
diff --git a/src/libcec/org.kde.plasma.remotecontrollers.CEC.xml b/src/libcec/org.kde.plasma.remotecontrollers.CEC.xml
index d909dfa..947f927 100644
--- a/src/libcec/org.kde.plasma.remotecontrollers.CEC.xml
+++ b/src/libcec/org.kde.plasma.remotecontrollers.CEC.xml
@@ -3,6 +3,9 @@
   <interface name="org.kde.plasma.remotecontrollers.CEC">
     <signal name="enterStandby">
     </signal>
+    <signal name="sourceActivated">
+      <arg type="b" direction="out"/>
+    </signal>
     <method name="sendNextKey">
       <arg type="i" direction="out"/>
     </method>
-- 
2.40.0


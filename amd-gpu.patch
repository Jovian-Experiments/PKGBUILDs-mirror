From 567a8ea236c8cde3631fa2a2c15b0f8a18cecd7c Mon Sep 17 00:00:00 2001
From: Mario Limonciello <mario.limonciello@amd.com>
Date: Fri, 20 Sep 2024 11:02:08 -0500
Subject: [PATCH] trivial: amd-gpu: read 1 byte instead of 0 bytes

This should help with failures triggering the write process in the kernel.

Suggested-by: Richard Hughes <richard@hughsie.com>
Signed-off-by: Mario Limonciello <mario.limonciello@amd.com>
(cherry picked from commit adc581ccd5bc56e685fb53768f8b83a96fc21d2d)
---
 plugins/amd-gpu/fu-amd-gpu-device.c | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

diff --git a/plugins/amd-gpu/fu-amd-gpu-device.c b/plugins/amd-gpu/fu-amd-gpu-device.c
index 1f75f4eef..73bb2e928 100644
--- a/plugins/amd-gpu/fu-amd-gpu-device.c
+++ b/plugins/amd-gpu/fu-amd-gpu-device.c
@@ -217,6 +217,7 @@ fu_amd_gpu_device_write_firmware(FuDevice *device,
 	g_autofree gchar *psp_vbflash = NULL;
 	g_autoptr(FuIOChannel) image_io = NULL;
 	g_autoptr(GBytes) fw = NULL;
+	g_autoptr(GError) error_read = NULL;
 	const gchar *base;
 
 	base = fu_udev_device_get_sysfs_path(FU_UDEV_DEVICE(device));
@@ -236,8 +237,14 @@ fu_amd_gpu_device_write_firmware(FuDevice *device,
 		return FALSE;
 
 	/* trigger the update (this looks funny but amdgpu returns 0 bytes) */
-	if (!fu_io_channel_read_raw(image_io, NULL, 0, NULL, 100, FU_IO_CHANNEL_FLAG_NONE, NULL))
-		g_debug("triggered update");
+	if (!fu_io_channel_read_raw(image_io,
+				    NULL,
+				    1,
+				    NULL,
+				    100,
+				    FU_IO_CHANNEL_FLAG_NONE,
+				    &error_read))
+		g_debug("triggered update: %s", error_read->message);
 
 	/* poll for completion */
 	return fu_device_retry_full(device,
-- 
2.43.0

From 7ef3f323ca0e297753c615a53d393543178848ec Mon Sep 17 00:00:00 2001
From: Mario Limonciello <mario.limonciello@amd.com>
Date: Fri, 27 Sep 2024 00:00:12 -0500
Subject: [PATCH] amd-gpu: Only compare the first 10 characters of part number

Apparently the rest of the characters are not relevant for the purpose
of making sure a firmware applies to a given part.

So shorten the GUID and only compare 10 characters from the rest.

(cherry picked from commit beb36b0ae846dd02dbb9e7faa1f2da0feb02edda)
---
 plugins/amd-gpu/fu-amd-gpu-device.c | 9 +++++----
 1 file changed, 5 insertions(+), 4 deletions(-)

diff --git a/plugins/amd-gpu/fu-amd-gpu-device.c b/plugins/amd-gpu/fu-amd-gpu-device.c
index 73bb2e928..aeede31c2 100644
--- a/plugins/amd-gpu/fu-amd-gpu-device.c
+++ b/plugins/amd-gpu/fu-amd-gpu-device.c
@@ -29,6 +29,8 @@ struct _FuAmdGpuDevice {
 #define PSPVBFLASH_IN_PROGRESS 0x1
 #define PSPVBFLASH_SUCCESS     0x80000000
 
+#define PART_NUM_STR_SIZE 10
+
 G_DEFINE_TYPE(FuAmdGpuDevice, fu_amd_gpu_device, FU_TYPE_UDEV_DEVICE)
 
 static gboolean
@@ -126,8 +128,7 @@ fu_amd_gpu_device_setup(FuDevice *device, GError **error)
 				  1000,
 				  error))
 		return FALSE;
-	self->vbios_pn =
-	    fu_strsafe((const gchar *)vbios_info.vbios_pn, sizeof(vbios_info.vbios_pn));
+	self->vbios_pn = fu_strsafe((const gchar *)vbios_info.vbios_pn, PART_NUM_STR_SIZE);
 	part = g_strdup_printf("AMD\\%s", self->vbios_pn);
 	fu_device_add_instance_id(device, part);
 	fu_device_set_version_raw(device, vbios_info.version);
@@ -150,7 +151,7 @@ fu_amd_gpu_device_prepare_firmware(FuDevice *device,
 	g_autoptr(FuFirmware) ish_a = NULL;
 	g_autoptr(FuFirmware) partition_a = NULL;
 	g_autoptr(FuFirmware) csm = NULL;
-	const gchar *fw_pn;
+	g_autofree gchar *fw_pn = NULL;
 
 	if (!fu_firmware_parse(firmware, fw, flags, error))
 		return NULL;
@@ -166,7 +167,7 @@ fu_amd_gpu_device_prepare_firmware(FuDevice *device,
 	if (csm == NULL)
 		return NULL;
 
-	fw_pn = fu_amd_gpu_atom_get_vbios_pn(csm);
+	fw_pn = fu_strsafe(fu_amd_gpu_atom_get_vbios_pn(csm), PART_NUM_STR_SIZE);
 	if (g_strcmp0(fw_pn, self->vbios_pn) != 0) {
 		g_set_error(error,
 			    FWUPD_ERROR,
-- 
2.43.0

